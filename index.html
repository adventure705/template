<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í…œí”Œë¦¿ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons ë¡œë“œ (ì•„ì´ì½˜ ì‚¬ìš©) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDK ë¡œë“œ (í´ë¼ìš°ë“œ ë™ê¸°í™”ë¥¼ ìœ„í•´ ë³µêµ¬) -->
    <script type="module">
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // batchë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ writeBatch, runTransactionì„ ì¶”ê°€í•©ë‹ˆë‹¤.
        import { getFirestore, doc, getDoc, addDoc, setDoc, onSnapshot, collection, query, where, getDocs, deleteDoc, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firestore ë””ë²„ê·¸ ë¡œê¹… í™œì„±í™”
        setLogLevel('debug');

        // ì „ì—­ ë³€ìˆ˜ ì„¤ì •ì„ ìœ„í•œ í—¬í¼ í•¨ìˆ˜
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken,
            getFirestore, doc, getDoc, addDoc, setDoc, onSnapshot, collection, query, where, getDocs, deleteDoc, serverTimestamp, writeBatch
        };
        
        // =========================================================================
        // âš ï¸ ì‚¬ìš©ì ì„¤ì • ì˜ì—­
        // =========================================================================
        const firebaseConfigFromCanvas = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appIdFromCanvas = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthTokenFromCanvas = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // ğŸš¨ ì—¬ê¸°ì— ì‹¤ì œ Firebase config ê°’ì„ ì…ë ¥í•˜ì„¸ìš”.
        const customFirebaseConfig = {
            apiKey: "AIzaSyDdk_axp2Q9OANqleknWeYWK9DrxKWKeY4", 
            authDomain: "template-3530f.firebaseapp.com",
            projectId: "template-3530f", 
            storageBucket: "template-3530f.firebasestorage.app",
            messagingSenderId: "891098188622",
            appId: "1:891098188622:web:392c0121a17f1cd4402c1f"
        };
        
        // Canvas í™˜ê²½ì¸ì§€ ì™¸ë¶€ í™˜ê²½ì¸ì§€ í™•ì¸í•˜ì—¬ ìµœì¢… ì„¤ì • ì ìš©
        window.firebaseConfig = Object.keys(firebaseConfigFromCanvas).length > 0 ? firebaseConfigFromCanvas : customFirebaseConfig;
        window.appId = appIdFromCanvas !== 'default-app-id' ? appIdFromCanvas : window.firebaseConfig.projectId || 'default-app-id';
        window.initialAuthToken = initialAuthTokenFromCanvas;

    </script>
    
    <style>
        /* [ìš”ì²­ì‚¬í•­ ë°˜ì˜] ëª¨ë“  í…ìŠ¤íŠ¸ì— Arial í°íŠ¸ ì ìš© */
        body, button, input, select, textarea, .document-container, #templateEditor, .downloaded-content {
            font-family: 'Arial', sans-serif !important;
        }
        
        /* contentEditable divì˜ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        #templateEditor {
            min-height: 400px;
            border: 1px solid #ccc;
            padding: 20px;
            background-color: white;
            line-height: 1.6;
            cursor: text;
        }
        #templateEditor:focus {
            outline: none;
        }
        /* ë‹¤ìš´ë¡œë“œëœ HTML íŒŒì¼ì˜ ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì •ì˜ */
        .downloaded-content {
            box-sizing: border-box;
            max-width: 800px;
            margin: 0 auto;
        }
        .toolbar-button {
            padding: 8px 10px;
            border-radius: 6px;
            transition: background-color 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid transparent;
        }
        .toolbar-button:hover {
            background-color: #e5e7eb;
            border-color: #d1d5db;
        }
        /* ëª©ë¡ ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        #nameListContainer, #templateList {
            max-height: 300px;
            overflow-y: auto;
        }
        /* ë©”ì¸ ë·°ì˜ ì„¹ì…˜ ì»¨í…Œì´ë„ˆê°€ flexboxë¥¼ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì • */
        #homeSections {
            display: flex;
            gap: 1.5rem;
        }
        /* í…œí”Œë¦¿ ì„ íƒê³¼ ë§í¬/ì´ë¦„ ì…ë ¥ ì„¹ì…˜ì´ flex itemìœ¼ë¡œ ë™ì‘í•˜ë©° ì„¸ë¡œ ë†’ì´ë¥¼ ë§ì¶¤ */
        #templateSelectionBlock, #linkInputBlock {
            flex: 1;
        }
        
        /* íˆ´ë°” êµ¬ë¶„ì„  */
        .toolbar-divider {
            width: 1px;
            height: 24px;
            background-color: #d1d5db;
            margin: 0 4px;
            align-self: center;
        }
        
        /* ìƒ‰ìƒ ì„ íƒê¸° ë˜í¼ */
        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 4px;
            border: 1px solid #e5e7eb;
            padding: 2px 6px;
            border-radius: 6px;
            background-color: white;
        }
        .color-label {
            font-size: 12px;
            color: #4b5563;
        }
        /* Drag & Drop ìŠ¤íƒ€ì¼ */
        #nameListContainer > div[draggable="true"], #templateList > div[draggable="true"] {
            transition: background-color 0.2s;
        }
        
        /* í…œí”Œë¦¿ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        #templateList > div {
            cursor: grab; /* ë“œë˜ê·¸ ê°€ëŠ¥í•¨ì„ ëª…ì‹œ */
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

    <div class="max-w-5xl mx-auto bg-white shadow-xl rounded-xl p-6 md:p-10">
        <h1 class="text-3xl font-bold mb-6 text-gray-800 border-b pb-2">í…œí”Œë¦¿ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
        
        <!-- ë„¤ë¹„ê²Œì´ì…˜ íƒ­ -->
        <div class="flex mb-6 border-b border-gray-200">
            <button id="navHome" class="px-4 py-2 text-lg font-medium border-b-2 border-transparent text-gray-500 hover:text-indigo-600 hover:border-indigo-600 transition duration-150 mr-4">
                âœ¨ í…œí”Œë¦¿ ì‚¬ìš©
            </button>
            <button id="navEditor" class="px-4 py-2 text-lg font-medium border-b-2 border-transparent text-gray-500 hover:text-indigo-600 hover:border-indigo-600 transition duration-150">
                âš™ï¸ í…œí”Œë¦¿ í¸ì§‘/ê´€ë¦¬
            </button>
        </div>

        <div id="statusMessage" class="hidden p-3 mb-4 rounded-lg text-sm" role="alert"></div>
        <div id="loadingIndicator" class="p-4 bg-yellow-100 rounded-lg text-center text-yellow-800 hidden">
            <div class="flex items-center justify-center">
                <i data-lucide="loader-2" class="w-5 h-5 animate-spin mr-2"></i>
                ë°ì´í„° ë¡œë“œ ì¤‘...
            </div>
        </div>

        <!-- ë·° ì»¨í…Œì´ë„ˆ -->
        <div id="mainViewContainer">
            <!-- Home View (Template Selector & Substitution) -->
            <div id="homeView" class="view-content">
                
                <!-- 1. í…œí”Œë¦¿ ì„ íƒ & 2. ë§í¬ ë° ì´ë¦„ ì…ë ¥ ì„¹ì…˜ (Flexboxë¡œ ë†’ì´ í†µì¼) -->
                <div id="homeSections" class="mb-8 flex flex-col md:flex-row">
                    <!-- 1. í…œí”Œë¦¿ ì„ íƒ -->
                    <div id="templateSelectionBlock" class="p-4 border rounded-lg bg-gray-50 mb-6 md:mb-0">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800">1. í…œí”Œë¦¿ ì„ íƒ</h2>
                        <label for="templateSelect" class="block text-sm font-medium text-gray-700 mb-2">ì‚¬ìš©í•  í…œí”Œë¦¿ ì„ íƒ</label>
                        <select id="templateSelect" class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white mb-3">
                            <option value="">-- í…œí”Œë¦¿ì„ ì„ íƒí•˜ì„¸ìš” --</option>
                        </select>
                        <button id="loadTemplateBtn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 rounded-lg transition duration-200" disabled>
                            ì„ íƒí•œ í…œí”Œë¦¿ ë¡œë“œ
                        </button>
                    </div>

                    <!-- 2. ë§í¬ ë° ì´ë¦„ ì…ë ¥ -->
                    <div id="linkInputBlock" class="p-4 border rounded-lg bg-indigo-50/50">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800">2. ë§í¬ ë° ì´ë¦„ ì…ë ¥</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="linkInput1" class="block text-sm font-medium text-gray-700 mb-1">ë§í¬ 1 URL ([LINK1_POS])</label>
                                <input type="url" id="linkInput1" placeholder="e.g., https://www.google.com" 
                                       class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                            <div>
                                <label for="linkInput2" class="block text-sm font-medium text-gray-700 mb-1">ë§í¬ 2 URL ([LINK2_POS])</label>
                                <input type="url" id="linkInput2" placeholder="e.g., https://www.github.com"
                                       class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                            <div>
                                <label for="nameSelectHome" class="block text-sm font-medium text-gray-700 mb-1">ë¬¸ì„œ ë‚´ ì´ë¦„ ì„ íƒ ([NAME_POS])</label>
                                <select id="nameSelectHome" class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white">
                                    <option value="">-- ì´ë¦„ ì„ íƒ ì•ˆ í•¨ --</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- NEW: Link 3 and Link 4 (Optional) -->
                        <div class="mt-4 pt-4 border-t border-indigo-200">
                            <h3 class="text-xl font-medium text-gray-700 mb-3">ì¶”ê°€ ë§í¬ (ì„ íƒ ì‚¬í•­)</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="linkInput3" class="block text-sm font-medium text-gray-700 mb-1">ë§í¬ 3 URL ([LINK3_POS])</label>
                                    <input type="url" id="linkInput3" placeholder="e.g., https://www.example.com/3"
                                           class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                                </div>
                                <div>
                                    <label for="linkInput4" class="block text-sm font-medium text-gray-700 mb-1">ë§í¬ 4 URL ([LINK4_POS])</label>
                                    <input type="url" id="linkInput4" placeholder="e.g., https://www.example.com/4"
                                           class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Customer Name Input for Filename -->
                        <div class="mt-4 pt-4 border-t border-indigo-200">
                            <label for="customerNameInput" class="block text-sm font-medium text-gray-700 mb-1">
                                íŒŒì¼ ì´ë¦„ì— ì‚¬ìš©í•  ê³ ê° ì´ë¦„ (ì„ íƒ ì‚¬í•­)
                            </label>
                            <input type="text" id="customerNameInput" placeholder="ì˜ˆ: í™ê¸¸ë™"
                                class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                    </div>
                </div>

                <!-- 3. ì¹˜í™˜ ë° 4. ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ (ê°€ë¡œí­ í†µì¼) -->
                <div class="grid grid-cols-2 gap-4 mb-8">
                    <!-- Substitution Area (3) -->
                    <button id="processBtn"
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-8 rounded-lg shadow-md transition duration-200 text-lg" disabled>
                        3. í”Œë ˆì´ìŠ¤í™€ë” ì¹˜í™˜ ë° ë¯¸ë¦¬ë³´ê¸°
                    </button>
                
                    <!-- Download Button (4) -->
                    <button id="downloadBtn" disabled
                            class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transition duration-200 text-lg">
                        4. HTML íŒŒì¼ ë‹¤ìš´ë¡œë“œ (.html)
                    </button>
                </div>

                <!-- Final Preview (No Number) -->
                <h2 class="text-2xl font-bold mb-4 text-gray-800">ìµœì¢… ë¬¸ì„œ ë¯¸ë¦¬ë³´ê¸°</h2>
                <div id="previewArea" class="p-5 border border-dashed border-gray-300 bg-gray-50 rounded-lg min-h-[100px] document-container">
                    <p class="text-gray-500 italic">í…œí”Œë¦¿ì„ ë¡œë“œí•˜ê³  í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ì¹˜í™˜í•˜ë©´ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
                
            </div>

            <!-- Editor View (Template Management & Name List) -->
            <div id="editorView" class="view-content hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">1. í…œí”Œë¦¿ ê´€ë¦¬ (ìˆœì„œ ë³€ê²½ ê°€ëŠ¥)</h2>

                <!-- Template List -->
                <div class="mb-6 p-4 border rounded-lg bg-white shadow-sm">
                    <h3 class="text-xl font-semibold mb-3 border-b pb-2">ì €ì¥ëœ í…œí”Œë¦¿ ëª©ë¡ (ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½)</h3>
                    <div id="templateList" class="divide-y divide-gray-100">
                        <p class="text-gray-500 text-sm p-1">í…œí”Œë¦¿ì„ ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...</p>
                    </div>
                    <button id="newTemplateBtn" class="mt-4 w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200 text-sm">
                        + ìƒˆ í…œí”Œë¦¿ ìƒì„±
                    </button>
                </div>

                <!-- Template Editor Panel (Hidden by default) -->
                <div id="templateEditorPanel" class="hidden border-2 p-6 rounded-xl bg-gray-50 mb-6">
                    <h3 id="editorTitleText" class="text-xl font-bold mb-4">ìƒˆ í…œí”Œë¦¿</h3>
                    
                    <label for="templateTitleInput" class="block text-sm font-medium text-gray-700 mb-1">í…œí”Œë¦¿ ì œëª©</label>
                    <input type="text" id="templateTitleInput" placeholder="í…œí”Œë¦¿ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full p-2 border border-gray-300 rounded-lg text-sm mb-4">

                    <!-- Template Editor -->
                    <label for="templateEditor" class="block text-lg font-medium text-gray-700 mb-2">
                        í…œí”Œë¦¿ ë‚´ìš© í¸ì§‘
                        <span class="text-sm font-normal text-gray-500 block" style="font-family: Arial, sans-serif !important;">
                            (í”Œë ˆì´ìŠ¤í™€ë” ì‚¬ìš©: 
                            <code style="font-family: Arial, sans-serif !important;">[LINK1_POS]</code>, 
                            <code style="font-family: Arial, sans-serif !important;">[LINK2_POS]</code>, 
                            <code style="font-family: Arial, sans-serif !important;">[LINK3_POS]</code>, 
                            <code style="font-family: Arial, sans-serif !important;">[LINK4_POS]</code>, 
                            <code style="font-family: Arial, sans-serif !important;">[NAME_POS]</code>)
                        </span>
                    </label>
                    
                    <!-- í™•ì¥ëœ ì—ë””í„° íˆ´ë°” -->
                    <div id="toolbar" class="flex flex-wrap items-center gap-1 p-2 bg-gray-100 border border-b-0 border-gray-300 rounded-t-lg">
                        <!-- ê¸°ë³¸ ì„œì‹ -->
                        <button class="toolbar-button" data-command="bold" title="êµµê²Œ"><i data-lucide="bold" class="w-5 h-5"></i></button>
                        <button class="toolbar-button" data-command="italic" title="ê¸°ìš¸ì„ê¼´"><i data-lucide="italic" class="w-5 h-5"></i></button>
                        <button class="toolbar-button" data-command="underline" title="ë°‘ì¤„"><i data-lucide="underline" class="w-5 h-5"></i></button>
                        
                        <div class="toolbar-divider"></div>

                        <!-- ëª©ë¡ -->
                        <button class="toolbar-button" data-command="insertUnorderedList" title="ê¸€ë¨¸ë¦¬ ê¸°í˜¸ ëª©ë¡"><i data-lucide="list" class="w-5 h-5"></i></button>
                        <button class="toolbar-button" data-command="insertOrderedList" title="ë²ˆí˜¸ ë§¤ê¸°ê¸° ëª©ë¡"><i data-lucide="list-ordered" class="w-5 h-5"></i></button>
                        
                        <div class="toolbar-divider"></div>

                        <!-- ìŠ¤íƒ€ì¼ ë° í°íŠ¸ -->
                        <select id="formatBlock" class="p-1 border border-gray-300 rounded-lg text-sm bg-white h-9" title="ì œëª© ìŠ¤íƒ€ì¼">
                            <option value="P">ë³¸ë¬¸</option>
                            <option value="H2">ì œëª© 2</option>
                            <option value="H3">ì œëª© 3</option>
                            <option value="H4">ì œëª© 4</option>
                        </select>

                        <!-- ê¸€ì”¨ì²´ ì„ íƒ -->
                        <select id="fontName" class="p-1 border border-gray-300 rounded-lg text-sm bg-white h-9" title="ê¸€ê¼´">
                            <option value="Arial" selected>Arial</option>
                            <option value="Courier New">Courier New</option>
                            <option value="Georgia">Georgia</option>
                            <option value="Times New Roman">Times New Roman</option>
                            <option value="Verdana">Verdana</option>
                        </select>

                        <!-- ê¸€ê¼´ í¬ê¸° ì…ë ¥ (ìˆ«ì ì…ë ¥ í•„ë“œ) -->
                        <div class="flex items-center space-x-1" title="ê¸€ê¼´ í¬ê¸° (1-7 ì‚¬ì´ì˜ ìˆ«ì ì…ë ¥)">
                            <label for="fontSizeInput" class="text-sm text-gray-700">í¬ê¸°:</label>
                            <input type="number" id="fontSizeInput" min="1" max="7" value="3" 
                                class="p-1 border border-gray-300 rounded-lg text-sm w-16 h-9 text-center" 
                                title="ê¸€ê¼´ í¬ê¸° (1-7 ì‚¬ì´ì˜ ìˆ«ì ì…ë ¥)">
                            <button id="applyFontSizeBtn" class="bg-gray-200 hover:bg-gray-300 p-1 rounded-md text-sm transition duration-150" title="ì„ íƒ ì˜ì—­ì— í¬ê¸° ì ìš©">
                                ì ìš©
                            </button>
                        </div>
                        
                        <div class="toolbar-divider"></div>

                        <!-- ê¸€ì”¨ ìƒ‰ìƒ ë° ë°°ê²½ ìƒ‰ìƒ -->
                        <div class="color-picker-wrapper" title="ê¸€ì ìƒ‰ìƒ">
                            <span class="color-label">ê¸€ì</span>
                            <input type="color" id="foreColorPicker" class="w-6 h-6 p-0 border-none bg-transparent cursor-pointer" value="#000000">
                        </div>

                        <div class="color-picker-wrapper" title="ë°°ê²½ ìƒ‰ìƒ (í˜•ê´‘íœ)">
                            <span class="color-label">ë°°ê²½</span>
                            <input type="color" id="backColorPicker" class="w-6 h-6 p-0 border-none bg-transparent cursor-pointer" value="#ffffff">
                        </div>
                    </div>
                    
                    <div id="templateEditor" contenteditable="true" class="document-container rounded-b-lg border-2 border-t-0 border-gray-300 focus-within:border-blue-500 transition duration-150 shadow-sm">
                        <p style="font-size: 16px; margin-bottom: 12pt;">ìƒˆë¡œìš´ í…œí”Œë¦¿ ë‚´ìš©ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê±°ë‚˜ í¸ì§‘í•˜ì„¸ìš”.</p>
                        <p style="font-size: 16px; margin-bottom: 12pt;">ì˜ˆì‹œ: Dear <span style="font-weight: bold;">[NAME_POS]</span>, ìì„¸í•œ ë‚´ìš©ì€ [LINK1_POS]ì—ì„œ í™•ì¸í•˜ì„¸ìš”.</p>
                    </div>

                    <div class="flex justify-end gap-3 mt-4">
                        <button id="cancelEditBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">ì·¨ì†Œ</button>
                        <button id="saveTemplateBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">í…œí”Œë¦¿ ì €ì¥</button>
                    </div>
                </div>

                <!-- Name Manager Section (Moved to Editor View) -->
                <div class="border p-4 rounded-lg bg-white shadow-sm">
                    <h2 class="text-xl font-bold mb-4 text-gray-700">2. ì´ë¦„ ê´€ë¦¬ (ì¶”ê°€/ì‚­ì œ/ìˆœì„œ ë³€ê²½)</h2>
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="newNameInput" placeholder="ì¶”ê°€í•  ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                               class="flex-grow p-2 border border-gray-300 rounded-lg text-sm">
                        <button id="addNameBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200 text-sm">
                            ì¶”ê°€
                        </button>
                    </div>
                    <div id="nameListContainer" class="border border-gray-200 p-2 rounded-lg bg-gray-50">
                        <p class="text-gray-500 text-sm p-1">ì €ì¥ëœ ì´ë¦„ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
        </div>
        
    </div>

    <script type="module">
        
        // --- UI Elements ---
        const navHome = document.getElementById('navHome');
        const navEditor = document.getElementById('navEditor');
        const homeView = document.getElementById('homeView');
        const editorView = document.getElementById('editorView');
        const statusMessage = document.getElementById('statusMessage');
        const loadingIndicator = document.getElementById('loadingIndicator');

        const templateSelect = document.getElementById('templateSelect');
        const nameSelectHome = document.getElementById('nameSelectHome');
        const loadTemplateBtn = document.getElementById('loadTemplateBtn');
        const linkInput1 = document.getElementById('linkInput1');
        const linkInput2 = document.getElementById('linkInput2');
        const linkInput3 = document.getElementById('linkInput3');
        const linkInput4 = document.getElementById('linkInput4');
        const processBtn = document.getElementById('processBtn');
        const previewArea = document.getElementById('previewArea');
        const downloadBtn = document.getElementById('downloadBtn');
        const customerNameInput = document.getElementById('customerNameInput'); 

        const templateListContainer = document.getElementById('templateList');
        const newTemplateBtn = document.getElementById('newTemplateBtn');
        const templateEditorPanel = document.getElementById('templateEditorPanel');
        const editorTitleText = document.getElementById('editorTitleText');
        const templateTitleInput = document.getElementById('templateTitleInput');
        const templateEditor = document.getElementById('templateEditor');
        const toolbar = document.getElementById('toolbar');
        const formatBlockSelect = document.getElementById('formatBlock');
        const fontNameSelect = document.getElementById('fontName');
        const fontSizeInput = document.getElementById('fontSizeInput');
        const applyFontSizeBtn = document.getElementById('applyFontSizeBtn');
        const foreColorPicker = document.getElementById('foreColorPicker');
        const backColorPicker = document.getElementById('backColorPicker');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const saveTemplateBtn = document.getElementById('saveTemplateBtn');
        const newNameInput = document.getElementById('newNameInput');
        const addNameBtn = document.getElementById('addNameBtn');
        const nameListContainer = document.getElementById('nameListContainer');

        // --- State and Constants ---
        let currentView = 'home';
        let templates = [];
        let names = []; 
        let currentEditingTemplateId = null;
        let currentLoadedTemplate = null;
        let draggedNameItem = null;
        let draggedTemplateItem = null; // New state for template D&D

        const PLACEHOLDERS = {
            LINK1: '[LINK1_POS]',
            LINK2: '[LINK2_POS]',
            LINK3: '[LINK3_POS]',
            LINK4: '[LINK4_POS]',
            NAME: '[NAME_POS]'
        };
        const FONT_FAMILY = 'Arial, sans-serif';
        const TEMPLATE_STORAGE_KEY = 'template_manager_templates';
        const NAME_STORAGE_KEY = 'template_manager_names';
        
        // --- Firebase/Local State ---
        
        let app = null;
        let db = null;
        let auth = null;
        let userId = null; 
        let isAuthReady = false;
        
        // =========================================================
        // âœ… ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        // =========================================================
        function showStatus(message, type = 'success') {
            statusMessage.textContent = message;
            
            statusMessage.classList.remove(
                'hidden', 
                'bg-red-100', 'border-red-400', 'text-red-700', 
                'bg-green-100', 'border-green-400', 'text-green-700', 
                'border'
            );
            
            if (type === 'error') {
                statusMessage.classList.add('bg-red-100', 'border-red-400', 'text-red-700', 'border');
            } else {
                statusMessage.classList.add('bg-green-100', 'border-green-400', 'text-green-700', 'border');
            }
            
            statusMessage.classList.remove('hidden');
        }

        function switchView(viewName) {
            currentView = viewName;
            homeView.classList.toggle('hidden', viewName !== 'home');
            editorView.classList.toggle('hidden', viewName !== 'editor');
            
            navHome.classList.toggle('border-indigo-600', viewName === 'home');
            navHome.classList.toggle('text-indigo-600', viewName === 'home');
            navHome.classList.toggle('border-transparent', viewName !== 'home');
            navHome.classList.toggle('text-gray-500', viewName !== 'home');

            navEditor.classList.toggle('border-indigo-600', viewName === 'editor');
            navEditor.classList.toggle('text-indigo-600', viewName === 'editor');
            navEditor.classList.toggle('border-transparent', viewName !== 'editor');
            navEditor.classList.toggle('text-gray-500', viewName !== 'editor');

            if (viewName === 'editor') {
                hideTemplateEditor();
            }
            lucide.createIcons(); 
        }

        // Firestore ì»¬ë ‰ì…˜ ì°¸ì¡° ê°€ì ¸ì˜¤ê¸°
        function getCollectionRef(collectionName) {
            const { collection } = window.firebase;
            const currentAppId = window.appId || 'default-app-id';
            // í…œí”Œë¦¿ì€ í•­ìƒ ê³µê°œ ê²½ë¡œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
            return collection(db, 'artifacts', currentAppId, 'public', 'data', collectionName);
        }

        // âœ… FIX: ì´ë¦„ ë¬¸ì„œ ì°¸ì¡° (ê³µê°œ ê²½ë¡œë¡œ ë³€ê²½í•˜ì—¬ ê¸°ê¸° ê°„ ë™ê¸°í™”)
        function getSharedNamesDocRef() {
            const { doc } = window.firebase;
            const currentAppId = window.appId || 'default-app-id';
            // 'names' ì»¬ë ‰ì…˜ì˜ 'sharedNames' ë¬¸ì„œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
            return doc(db, 'artifacts', currentAppId, 'public', 'data', 'names', 'sharedNames');
        }

        // Firebase ì´ˆê¸°í™” ë° ì¸ì¦
        async function initFirebase() {
            loadingIndicator.classList.remove('hidden');

            const { initializeApp, getAuth, signInWithCustomToken, signInAnonymously, getFirestore } = window.firebase;
            const { firebaseConfig, initialAuthToken } = window;
            
            const isConfigValid = firebaseConfig && firebaseConfig.projectId && firebaseConfig.apiKey && 
                                firebaseConfig.projectId !== 'YOUR_PROJECT_ID_HERE' && firebaseConfig.apiKey !== 'YOUR_API_KEY_HERE';

            if (isConfigValid) {
                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    let userCredential;
                    if (initialAuthToken) {
                        userCredential = await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        userCredential = await signInAnonymously(auth);
                    }
                    userId = userCredential.user.uid;
                    isAuthReady = true;
                    console.log("Firebase Auth Ready. User ID:", userId);
                    startDataListeners();
                    showStatus("í´ë¼ìš°ë“œ ë™ê¸°í™” ëª¨ë“œë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. (ë‹¤ë¥¸ ì¥ì¹˜ì™€ ë°ì´í„° ê³µìœ  ê°€ëŠ¥)", 'success');

                } catch (error) {
                    console.error("Firebase initialization or authentication failed:", error);
                    showStatus("ê²½ê³ : Firebase ì¸ì¦ ë˜ëŠ” ê¶Œí•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ë¡œì»¬ ì €ì¥ì†Œë¡œ ì‘ë™)", 'error');
                    isAuthReady = false;
                    loadLocalData();
                }
            } else {
                console.warn("Firebase config not set. Switching to Local Storage mode.");
                isAuthReady = false;
                loadLocalData(); 
                showStatus("ì•ˆë‚´: Firebase ì„¤ì •ì´ ëˆ„ë½ë˜ì–´ ë¡œì»¬ ì €ì¥ì†Œ ëª¨ë“œë¡œ ì‘ë™í•©ë‹ˆë‹¤. (ë‹¤ë¥¸ ì¥ì¹˜ì™€ ë™ê¸°í™” ë¶ˆê°€)", 'success');
            }
            loadingIndicator.classList.add('hidden');
        }

        // ë°ì´í„° ë¦¬ìŠ¤ë„ˆ (ì‹¤ì‹œê°„ ë™ê¸°í™”)
        function startDataListeners() {
            if (!isAuthReady) return;

            // 1. Templates Listener (Public)
            const templateRef = getCollectionRef('templates');
            window.firebase.onSnapshot(templateRef, (snapshot) => {
                // sortIndexë¥¼ ê¸°ì¤€ìœ¼ë¡œ í…œí”Œë¦¿ì„ ì •ë ¬í•©ë‹ˆë‹¤.
                templates = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                templates.sort((a, b) => (a.sortIndex || 0) - (b.sortIndex || 0));
                
                renderTemplateSelect();
                renderTemplateList();
            }, (error) => {
                console.error("Template listener error:", error);
                showStatus("í…œí”Œë¦¿ ëª©ë¡ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ. (ê¶Œí•œ í™•ì¸ í•„ìš”)", 'error');
            });

            // 2. Names Listener (Shared Public)
            const nameDocRef = getSharedNamesDocRef(); // ë³€ê²½ëœ ê³µê°œ ê²½ë¡œ ì°¸ì¡°
            window.firebase.onSnapshot(nameDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    names = docSnapshot.data().namesArray || [];
                } else {
                    names = [];
                }
                
                renderNameSelects();
                renderNameList();
                
                if (names.length > 0) {
                    nameSelectHome.value = names[0];
                }
            }, (error) => {
                console.error("Name listener error:", error);
                showStatus("ì´ë¦„ ëª©ë¡ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ. (ê¶Œí•œ í™•ì¸ í•„ìš”)", 'error');
            });
        }
        
        // --- Local Storage ëŒ€ì²´ í•¨ìˆ˜ (Fallback/Debug ìš©) ---
        function loadLocalData() {
            templates = JSON.parse(localStorage.getItem(TEMPLATE_STORAGE_KEY) || '[]');
            templates.sort((a, b) => (a.sortIndex || 0) - (b.sortIndex || 0)); // ë¡œì»¬ì—ì„œë„ ì •ë ¬
            names = JSON.parse(localStorage.getItem(NAME_STORAGE_KEY) || '[]');
            renderTemplateSelect();
            renderTemplateList();
            renderNameSelects();
            renderNameList();
            if (names.length > 0) {
                nameSelectHome.value = names[0];
            }
        }
        
        // --- Template UI Rendering (Firebase/Local ê³µí†µ) ---

        function renderTemplateSelect() {
            templateSelect.innerHTML = '<option value="">-- í…œí”Œë¦¿ì„ ì„ íƒí•˜ì„¸ìš” --</option>';
            templates.forEach(t => {
                const option = document.createElement('option');
                option.value = t.id;
                option.textContent = t.title;
                templateSelect.appendChild(option);
            });
            loadTemplateBtn.disabled = !templateSelect.value;
        }

        function renderTemplateList() {
            templateListContainer.innerHTML = '';
            if (templates.length === 0) {
                templateListContainer.innerHTML = '<p class="text-gray-500 text-sm p-2">ì €ì¥ëœ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ë§Œë“¤ì–´ ë³´ì„¸ìš”.</p>';
                return;
            }

            templates.forEach(t => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-3 hover:bg-gray-50 transition duration-100 rounded-lg cursor-grab'; // cursor-grab ì¶”ê°€
                item.setAttribute('draggable', 'true'); // ë“œë˜ê·¸ ê°€ëŠ¥ ì†ì„± ì¶”ê°€
                item.setAttribute('data-id', t.id); // í…œí”Œë¦¿ ID ì €ì¥
                item.setAttribute('data-sort-index', t.sortIndex || 0); // ì •ë ¬ ì¸ë±ìŠ¤ ì €ì¥
                item.innerHTML = `
                    <div class="flex items-center space-x-2 w-full">
                        <i data-lucide="grip-vertical" class="w-4 h-4 text-gray-400"></i>
                        <span class="font-medium text-gray-700 truncate flex-grow">${t.title}</span>
                    </div>
                    <div class="flex gap-2">
                        <button data-id="${t.id}" class="edit-template-btn text-indigo-500 hover:text-indigo-700" title="í¸ì§‘">
                            <i data-lucide="pencil" class="w-4 h-4"></i>
                        </button>
                        <button data-id="${t.id}" class="delete-template-btn text-red-500 hover:text-red-700" title="ì‚­ì œ">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                templateListContainer.appendChild(item);
            });
            lucide.createIcons();
        }
        
        // âœ… NEW: í…œí”Œë¦¿ ìˆœì„œ ì €ì¥ í•¨ìˆ˜
        async function saveTemplateOrder(newTemplateOrder) {
            templates = newTemplateOrder; // ìƒíƒœ ì—…ë°ì´íŠ¸
            try {
                if (isAuthReady) {
                    const { writeBatch, getFirestore, doc } = window.firebase;
                    const batch = writeBatch(db);
                    const templateRef = getCollectionRef('templates');

                    newTemplateOrder.forEach((t, index) => {
                        const templateDocRef = doc(templateRef, t.id);
                        batch.update(templateDocRef, { sortIndex: index });
                    });
                    
                    await batch.commit();
                    showStatus('í…œí”Œë¦¿ ìˆœì„œê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

                } else {
                    // Local Storage ì €ì¥ ë¡œì§
                    newTemplateOrder.forEach((t, index) => {
                        const templateIndex = templates.findIndex(item => item.id === t.id);
                        if (templateIndex !== -1) {
                            templates[templateIndex].sortIndex = index;
                        }
                    });
                    templates.sort((a, b) => (a.sortIndex || 0) - (b.sortIndex || 0));
                    localStorage.setItem(TEMPLATE_STORAGE_KEY, JSON.stringify(templates));
                    renderTemplateList(); // ë¡œì»¬ ëª¨ë“œì—ì„œëŠ” ì§ì ‘ ë Œë”ë§ í˜¸ì¶œ
                }
                
                renderTemplateSelect(); // Home Selectë„ ì—…ë°ì´íŠ¸

            } catch (error) {
                console.error("Failed to save new template order:", error);
                showStatus("í…œí”Œë¦¿ ìˆœì„œ ë³€ê²½ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", 'error');
            }
        }

        // --- Template Editor Logic ---

        function showTemplateEditor(template = null) {
            templateEditorPanel.classList.remove('hidden');
            currentEditingTemplateId = template ? template.id : null;

            editorTitleText.textContent = template ? `í…œí”Œë¦¿ í¸ì§‘: ${template.title}` : 'ìƒˆ í…œí”Œë¦¿ ìƒì„±';
            templateTitleInput.value = template ? template.title : '';
            templateEditor.innerHTML = template ? template.content : 
                `<p style="font-size: 16px; margin-bottom: 12pt;">ìƒˆë¡œìš´ í…œí”Œë¦¿ ë‚´ìš©ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê±°ë‚˜ í¸ì§‘í•˜ì„¸ìš”.</p>
                 <p style="font-size: 16px; margin-bottom: 12pt;">ì˜ˆì‹œ: Dear <span style="font-weight: bold;">[NAME_POS]</span>, ìì„¸í•œ ë‚´ìš©ì€ [LINK1_POS]ì—ì„œ í™•ì¸í•˜ì„¸ìš”.</p>`;
        }

        function hideTemplateEditor() {
            templateEditorPanel.classList.add('hidden');
            currentEditingTemplateId = null;
        }

        async function saveTemplate() {
            const title = templateTitleInput.value.trim();
            const content = templateEditor.innerHTML;

            if (!title) {
                showStatus("í…œí”Œë¦¿ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", 'error');
                return;
            }
            
            // ìƒˆ í…œí”Œë¦¿ì¸ ê²½ìš°, í˜„ì¬ ê°€ì¥ í° sortIndex ë‹¤ìŒ ê°’ì„ ì§€ì •
            const newSortIndex = templates.reduce((max, t) => Math.max(max, t.sortIndex || 0), -1) + 1;

            const templateData = {
                title: title,
                content: content,
                link1Placeholder: PLACEHOLDERS.LINK1,
                link2Placeholder: PLACEHOLDERS.LINK2,
                link3Placeholder: PLACEHOLDERS.LINK3,
                link4Placeholder: PLACEHOLDERS.LINK4,
                namePlaceholder: PLACEHOLDERS.NAME,
            };
            
            if (!currentEditingTemplateId) {
                // ìƒˆ í…œí”Œë¦¿ì¼ ë•Œë§Œ sortIndexë¥¼ ì¶”ê°€
                templateData.sortIndex = newSortIndex;
            }

            try {
                if (isAuthReady) {
                    // Firebase ì €ì¥ ë¡œì§
                    const templateRef = getCollectionRef('templates');
                    if (currentEditingTemplateId) {
                        templateData.updatedAt = window.firebase.serverTimestamp();
                        await window.firebase.setDoc(window.firebase.doc(templateRef, currentEditingTemplateId), templateData, { merge: true });
                    } else {
                        templateData.createdAt = window.firebase.serverTimestamp();
                        await window.firebase.addDoc(templateRef, templateData);
                    }
                } else {
                    // Local Storage ì €ì¥ ë¡œì§ (Fallback)
                    if (currentEditingTemplateId) {
                        const index = templates.findIndex(t => t.id === currentEditingTemplateId);
                        if (index !== -1) templates[index] = { ...templates[index], ...templateData, updatedAt: new Date().toISOString() };
                    } else {
                        templates.push({ ...templateData, id: crypto.randomUUID(), sortIndex: newSortIndex, updatedAt: new Date().toISOString() });
                    }
                    localStorage.setItem(TEMPLATE_STORAGE_KEY, JSON.stringify(templates));
                    // ë¡œì»¬ ëª¨ë“œì—ì„œëŠ” ìˆ˜ë™ìœ¼ë¡œ UI ì—…ë°ì´íŠ¸ (ë¦¬ìŠ¤ë„ˆê°€ ì—†ìœ¼ë¯€ë¡œ)
                    templates.sort((a, b) => (a.sortIndex || 0) - (b.sortIndex || 0));
                    renderTemplateList();
                    renderTemplateSelect();
                }

                showStatus(`í…œí”Œë¦¿ "${title}"ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                hideTemplateEditor();
            } catch (error) {
                console.error("Save template failed:", error);
                showStatus("í…œí”Œë¦¿ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (í´ë¼ìš°ë“œ/ë¡œì»¬ ì €ì¥ì†Œ í™•ì¸)", 'error');
            }
        }

        async function deleteTemplate(templateId) {
            if (!confirm('ì •ë§ë¡œ ì´ í…œí”Œë¦¿ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                if (isAuthReady) {
                    // Firebase ì‚­ì œ ë¡œì§
                    const templateRef = getCollectionRef('templates');
                    await window.firebase.deleteDoc(window.firebase.doc(templateRef, templateId));
                } else {
                    // Local Storage ì‚­ì œ ë¡œì§
                    templates = templates.filter(t => t.id !== templateId);
                    localStorage.setItem(TEMPLATE_STORAGE_KEY, JSON.stringify(templates));
                    renderTemplateList();
                    renderTemplateSelect();
                }
                
                showStatus("í…œí”Œë¦¿ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", 'success');
                
                if (currentLoadedTemplate && currentLoadedTemplate.id === templateId) {
                    currentLoadedTemplate = null;
                    previewArea.innerHTML = '<p class="text-gray-500 italic">ì‚­ì œëœ í…œí”Œë¦¿ì…ë‹ˆë‹¤. ìƒˆ í…œí”Œë¦¿ì„ ë¡œë“œí•´ì£¼ì„¸ìš”.</p>';
                    processBtn.disabled = true;
                    downloadBtn.disabled = true;
                }
            } catch (error) {
                console.error("Delete template failed:", error);
                showStatus("í…œí”Œë¦¿ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", 'error');
            }
        }

        // --- Template Drag & Drop Handlers ---
        
        function handleTemplateDragStart(e) {
            const target = e.target.closest('div[draggable="true"][data-id]');
            if (!target) return;
            draggedTemplateItem = target;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', draggedTemplateItem.dataset.id);
            setTimeout(() => {
                target.classList.add('opacity-50', 'bg-yellow-200');
            }, 0);
        }

        function handleTemplateDragOver(e) {
            e.preventDefault(); 
            e.dataTransfer.dropEffect = 'move';
            if (!draggedTemplateItem) return;

            const target = e.target.closest('div[draggable="true"][data-id]');
            if (target && target !== draggedTemplateItem) {
                const container = templateListContainer;
                const bounding = target.getBoundingClientRect();
                const offset = bounding.y + (bounding.height / 2);
                
                if (e.clientY > offset) {
                    container.insertBefore(draggedTemplateItem, target.nextSibling);
                } else {
                    container.insertBefore(draggedTemplateItem, target);
                }
            }
        }

        function handleTemplateDrop(e) {
            e.preventDefault();
            if (!draggedTemplateItem) return;
            
            draggedTemplateItem.classList.remove('opacity-50', 'bg-yellow-200');
            
            const newTemplateOrder = Array.from(templateListContainer.children)
                                .map(item => templates.find(t => t.id === item.getAttribute('data-id')));
            
            // ê¸°ì¡´ ìˆœì„œì™€ ë‹¤ë¥¼ ë•Œë§Œ ì €ì¥ í•¨ìˆ˜ í˜¸ì¶œ
            const currentTemplateIds = templates.map(t => t.id).join(',');
            const newTemplateIds = newTemplateOrder.map(t => t.id).join(',');
            
            if (newTemplateIds !== currentTemplateIds) {
                saveTemplateOrder(newTemplateOrder);
            }
            draggedTemplateItem = null;
        }

        function handleTemplateDragEnd(e) {
            e.target.classList.remove('opacity-50', 'bg-yellow-200');
            draggedTemplateItem = null;
        }
        
        // --- Name Management Logic (Firebase/Local ê³µí†µ) ---

        function renderNameSelects() {
            const selectHtml = names.map(name => `<option value="${name}">${name}</option>`).join('');
            const baseOption = '<option value="">-- ì´ë¦„ ì„ íƒ ì•ˆ í•¨ --</option>';
            nameSelectHome.innerHTML = baseOption + selectHtml;
            
            if (names.length > 0) {
                nameSelectHome.value = names[0];
            }
        }

        function renderNameList() {
            nameListContainer.innerHTML = '';
            if (names.length === 0) {
                nameListContainer.innerHTML = '<p class="text-gray-500 text-sm p-1">ì €ì¥ëœ ì´ë¦„ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            names.forEach(name => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-1.5 border-b last:border-b-0 text-sm cursor-grab bg-white hover:bg-gray-100 rounded';
                item.setAttribute('draggable', 'true');
                item.setAttribute('data-name', name);
                item.innerHTML = `
                    <span class="truncate">${name}</span>
                    <div class="flex gap-2 items-center">
                        <i data-lucide="grip-vertical" class="w-4 h-4 text-gray-400"></i>
                        <button data-name="${name}" class="delete-name-btn text-red-500 hover:text-red-700 ml-2" title="ì´ë¦„ ì‚­ì œ">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                nameListContainer.appendChild(item);
            });
            lucide.createIcons();
        }

        async function saveNameOrder(newNames) {
             names = newNames;
             try {
                if (isAuthReady) {
                     const nameDocRef = getSharedNamesDocRef(); // âœ… FIX: ê³µê°œ ê²½ë¡œ ì‚¬ìš©
                     await window.firebase.setDoc(nameDocRef, { 
                        namesArray: newNames, 
                        updatedAt: window.firebase.serverTimestamp() 
                    }, { merge: true });
                } else {
                    localStorage.setItem(NAME_STORAGE_KEY, JSON.stringify(names));
                    renderNameList();
                }
                showStatus('ì´ë¦„ ìˆœì„œê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                renderNameSelects();
             } catch(error) {
                 console.error("Failed to save new name order:", error);
                 showStatus("ìˆœì„œ ë³€ê²½ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", 'error');
             }
        }
        
        async function addName() {
            const newName = newNameInput.value.trim();
            if (!newName) return;

            if (names.includes(newName)) {
                showStatus(`ì´ë¦„ "${newName}"ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.`, 'error');
                return;
            }

            let updatedNames = [...names, newName];
            
            try {
                if (isAuthReady) {
                    const nameDocRef = getSharedNamesDocRef(); // âœ… FIX: ê³µê°œ ê²½ë¡œ ì‚¬ìš©
                    await window.firebase.setDoc(nameDocRef, { 
                        namesArray: updatedNames, 
                        updatedAt: window.firebase.serverTimestamp() 
                    }, { merge: true });
                } else {
                    names = updatedNames;
                    localStorage.setItem(NAME_STORAGE_KEY, JSON.stringify(names));
                    renderNameList();
                    renderNameSelects();
                }

                newNameInput.value = '';
                showStatus(`ì´ë¦„ "${newName}"ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            } catch (error) {
                console.error("Add name failed:", error);
                showStatus("ì´ë¦„ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", 'error');
            }
        }

        async function deleteName(nameToDelete) {
            const newNames = names.filter(name => name !== nameToDelete);

            try {
                if (isAuthReady) {
                    const nameDocRef = getSharedNamesDocRef(); // âœ… FIX: ê³µê°œ ê²½ë¡œ ì‚¬ìš©
                    await window.firebase.setDoc(nameDocRef, { 
                        namesArray: newNames, 
                        updatedAt: window.firebase.serverTimestamp() 
                    }, { merge: true });
                } else {
                    names = newNames;
                    localStorage.setItem(NAME_STORAGE_KEY, JSON.stringify(names));
                    renderNameList();
                    renderNameSelects();
                }
                showStatus(`ì´ë¦„ "${nameToDelete}"ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            } catch (error) {
                console.error("Delete name failed:", error);
                showStatus("ì´ë¦„ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", 'error');
            }
        }

        // --- Name Drag and Drop Handlers (ê¸°ì¡´ ë¡œì§) ---

        function handleNameDragStart(e) {
            const target = e.target.closest('div[draggable="true"][data-name]');
            if (!target) return;
            draggedNameItem = target;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', draggedNameItem.dataset.name);
            setTimeout(() => {
                target.classList.add('opacity-50', 'bg-yellow-200');
            }, 0);
        }

        function handleNameDragOver(e) {
            e.preventDefault(); 
            e.dataTransfer.dropEffect = 'move';
            if (!draggedNameItem) return;

            const target = e.target.closest('div[draggable="true"][data-name]');
            if (target && target !== draggedNameItem) {
                const container = nameListContainer;
                const bounding = target.getBoundingClientRect();
                const offset = bounding.y + (bounding.height / 2);
                
                if (e.clientY > offset) {
                    container.insertBefore(draggedNameItem, target.nextSibling);
                } else {
                    container.insertBefore(draggedNameItem, target);
                }
            }
        }

        function handleNameDrop(e) {
            e.preventDefault();
            if (!draggedNameItem) return;
            
            draggedNameItem.classList.remove('opacity-50', 'bg-yellow-200');
            
            const newNames = Array.from(nameListContainer.children)
                                .map(item => item.getAttribute('data-name'));
            
            if (newNames.join(',') !== names.join(',')) {
                saveNameOrder(newNames); // ë¹„ë™ê¸° í•¨ìˆ˜ í˜¸ì¶œ (await ë¶ˆí•„ìš”)
            }
            draggedNameItem = null;
        }

        function handleNameDragEnd(e) {
            e.target.classList.remove('opacity-50', 'bg-yellow-200');
            draggedNameItem = null;
        }
        
        // --- Template Substitution Logic (Main Page) ---

        function loadSelectedTemplate() {
            const selectedId = templateSelect.value;
            if (!selectedId) {
                currentLoadedTemplate = null;
                processBtn.disabled = true;
                downloadBtn.disabled = true;
                previewArea.innerHTML = '<p class="text-gray-500 italic">í…œí”Œë¦¿ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>';
                showStatus('ë¡œë“œí•  í…œí”Œë¦¿ì„ ì„ íƒí•˜ì„¸ìš”.', 'error');
                return;
            }

            const template = templates.find(t => t.id === selectedId);
            if (template) {
                currentLoadedTemplate = template;
                previewArea.innerHTML = template.content;
                processBtn.disabled = false;
                downloadBtn.disabled = true;
                showStatus(`í…œí”Œë¦¿ "${template.title}"ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ì¹˜í™˜ ê°’ì„ ì…ë ¥í•˜ì„¸ìš”.`, 'success');
            } else {
                 showStatus('ì„ íƒëœ í…œí”Œë¦¿ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
            }
        }

        function processTemplate() {
            if (!currentLoadedTemplate) {
                showStatus('ë¨¼ì € **"ì„ íƒí•œ í…œí”Œë¦¿ ë¡œë“œ"** ë²„íŠ¼ì„ ëˆŒëŸ¬ í…œí”Œë¦¿ì„ ë¡œë“œí•´ì£¼ì„¸ìš”.', 'error');
                return null;
            }
            
            const templateHtml = currentLoadedTemplate.content;
            const url1 = linkInput1.value.trim();
            const url2 = linkInput2.value.trim();
            const url3 = linkInput3.value.trim();
            const url4 = linkInput4.value.trim();
            const selectedName = nameSelectHome.value;

            if (!url1) {
                showStatus('ë§í¬ 1 URLì€ í•„ìˆ˜ì…ë‹ˆë‹¤. ìœ íš¨í•œ ë§í¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                downloadBtn.disabled = true;
                return null;
            }
            
            try { new URL(url1); } catch (_) { showStatus('ë§í¬ 1 URLì˜ í˜•ì‹ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error'); downloadBtn.disabled = true; return null; }
            if (url2) { try { new URL(url2); } catch (_) { showStatus('ë§í¬ 2 URLì˜ í˜•ì‹ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error'); downloadBtn.disabled = true; return null; } }
            if (url3) { try { new URL(url3); } catch (_) { showStatus('ë§í¬ 3 URLì˜ í˜•ì‹ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error'); downloadBtn.disabled = true; return null; } }
            if (url4) { try { new URL(url4); } catch (_) { showStatus('ë§í¬ 4 URLì˜ í˜•ì‹ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error'); downloadBtn.disabled = true; return null; } }

            let processedHtml = templateHtml;
            const linkBaseStyle = `text-decoration: underline; font-family: ${FONT_FAMILY};`;

            // 1. Link 1 Substitution
            const linkTag1 = `<a href="${url1}" target="_blank" style="color: #1a0dab; ${linkBaseStyle}">${url1}</a>`;
            processedHtml = processedHtml.replace(
                new RegExp(PLACEHOLDERS.LINK1.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g'),
                linkTag1
            );

            // 2. Link 2 Substitution
            const linkTag2 = url2 ? 
                `<a href="${url2}" target="_blank" style="color: #059669; ${linkBaseStyle}">${url2}</a>` : '';
            processedHtml = processedHtml.replace(
                new RegExp(PLACEHOLDERS.LINK2.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g'),
                linkTag2
            );

            // 3. Link 3 Substitution
            const linkTag3 = url3 ? 
                `<a href="${url3}" target="_blank" style="color: #8b5cf6; ${linkBaseStyle}">${url3}</a>` : '';
            processedHtml = processedHtml.replace(
                new RegExp(PLACEHOLDERS.LINK3.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g'),
                linkTag3
            );

            // 4. Link 4 Substitution
            const linkTag4 = url4 ? 
                `<a href="${url4}" target="_blank" style="color: #f97316; ${linkBaseStyle}">${url4}</a>` : '';
            processedHtml = processedHtml.replace(
                new RegExp(PLACEHOLDERS.LINK4.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g'),
                linkTag4
            );

            // 5. Name Substitution
            const nameText = selectedName || 'Recipient';
            processedHtml = processedHtml.replace(
                new RegExp(PLACEHOLDERS.NAME.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g'),
                nameText
            );

            previewArea.innerHTML = processedHtml;
            downloadBtn.disabled = false;
            showStatus('í”Œë ˆì´ìŠ¤í™€ë”ê°€ ì¹˜í™˜ë˜ì—ˆìœ¼ë©° ë¯¸ë¦¬ë³´ê¸°ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ HTML íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'success');

            return processedHtml;
        }

        // Download HTML function (Unchanged)
        function downloadHtml() {
            const processedHtml = processTemplate();
            
            if (!processedHtml) {
                showStatus('ì²˜ë¦¬ëœ ë‚´ìš©ì´ ì—†ê±°ë‚˜ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¨¼ì € \'í”Œë ˆì´ìŠ¤í™€ë” ì¹˜í™˜ ë° ë¯¸ë¦¬ë³´ê¸°\'ë¥¼ í´ë¦­í•˜ì„¸ìš”.', 'error');
                return;
            }

            const customerName = customerNameInput.value.trim();
            const templateTitle = currentLoadedTemplate ? currentLoadedTemplate.title : 'í…œí”Œë¦¿_ë¬¸ì„œ';
            
            const now = new Date();
            const year = now.getFullYear().toString().slice(-2);
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const dateStamp = `${year}${month}${day}`;

            let filename = templateTitle.replace(/[^a-zA-Z0-9_\uAC00-\uD7A3]/g, '_'); 
            
            if (customerName) {
                filename += `_${customerName.replace(/[^a-zA-Z0-9_\uAC00-\uD7A3]/g, '')}`; 
            }
            
            filename += `_${dateStamp}.html`;

            const fullHtmlContent = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Downloaded Document</title>
    <!-- Enforce Arial font and standard document reset -->
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 40px;
            color: #212121;
            line-height: 1.6;
            background-color: #ffffff;
        }
        /* Crucial: Override all inherited styles to enforce Arial */
        .downloaded-content * {
            font-family: 'Arial', sans-serif !important;
        }
        .downloaded-content {
            box-sizing: border-box;
            max-width: 800px;
            margin: 0 auto;
        }
        /* Link styling for downloaded content */
        a {
            color: #1a0dab;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="downloaded-content">
        ${processedHtml}
    </div>
</body>
</html>
            `.trim();

            const blob = new Blob([fullHtmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus(`HTML íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. íŒŒì¼ëª…: ${filename}`, 'success');
        }

        // --- Event Listeners Initialization ---

        function initListeners() {
            // Navigation
            navHome.addEventListener('click', () => switchView('home'));
            navEditor.addEventListener('click', () => switchView('editor'));

            // Home View
            templateSelect.addEventListener('change', (e) => {
                loadTemplateBtn.disabled = !e.target.value;
            });
            loadTemplateBtn.addEventListener('click', loadSelectedTemplate);
            processBtn.addEventListener('click', processTemplate);
            downloadBtn.addEventListener('click', downloadHtml);

            // Editor View - Template Management
            newTemplateBtn.addEventListener('click', () => showTemplateEditor(null));
            cancelEditBtn.addEventListener('click', hideTemplateEditor);
            saveTemplateBtn.addEventListener('click', saveTemplate);
            
            templateListContainer.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-template-btn');
                const deleteBtn = e.target.closest('.delete-template-btn');

                if (editBtn) {
                    const templateId = editBtn.dataset.id;
                    const templateToEdit = templates.find(t => t.id === templateId);
                    if (templateToEdit) showTemplateEditor(templateToEdit);
                } else if (deleteBtn) {
                    deleteTemplate(deleteBtn.dataset.id);
                }
            });
            
            // âœ… NEW: Template Drag & Drop Listeners
            templateListContainer.addEventListener('dragstart', handleTemplateDragStart);
            templateListContainer.addEventListener('dragover', handleTemplateDragOver);
            templateListContainer.addEventListener('drop', handleTemplateDrop);
            templateListContainer.addEventListener('dragend', handleTemplateDragEnd); 

            // Editor View - Editing Toolbar
            toolbar.addEventListener('click', (e) => {
                const button = e.target.closest('.toolbar-button');
                if (button) {
                    executeCommand(button.dataset.command);
                }
            });
            formatBlockSelect.addEventListener('change', (e) => executeCommand('formatBlock', `<${e.target.value}>`));
            fontNameSelect.addEventListener('change', (e) => executeCommand('fontName', e.target.value));
            
            // ê¸€ê¼´ í¬ê¸° ì ìš© ë²„íŠ¼ ì´ë²¤íŠ¸ ì²˜ë¦¬
            applyFontSizeBtn.addEventListener('click', () => {
                const size = parseInt(fontSizeInput.value);
                if (size >= 1 && size <= 7) {
                    executeCommand('fontSize', size);
                } else {
                    showStatus('ê¸€ê¼´ í¬ê¸°ëŠ” 1ì—ì„œ 7 ì‚¬ì´ì˜ ìœ íš¨í•œ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤. (ê¸°ë³¸ í¬ê¸° 3)', 'error');
                    fontSizeInput.value = 3; 
                }
            });

            // ìˆ«ì ì…ë ¥ í•„ë“œì—ì„œ Enter í‚¤ë¥¼ ëˆŒë €ì„ ë•Œë„ ì ìš©
            fontSizeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    applyFontSizeBtn.click();
                }
            });
            
            foreColorPicker.addEventListener('input', (e) => executeCommand('foreColor', e.target.value));
            backColorPicker.addEventListener('input', (e) => executeCommand('hiliteColor', e.target.value));
            
            // Editor View - Name Management
            addNameBtn.addEventListener('click', addName);
            newNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addName(); });
            nameListContainer.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-name-btn');
                if (deleteBtn) deleteName(deleteBtn.dataset.name);
            });
            
            // Name Drag & Drop Event Listeners
            nameListContainer.addEventListener('dragstart', handleNameDragStart); // ê¸°ì¡´ í•¨ìˆ˜ ì´ë¦„ ë³€ê²½
            nameListContainer.addEventListener('dragover', handleNameDragOver);   // ê¸°ì¡´ í•¨ìˆ˜ ì´ë¦„ ë³€ê²½
            nameListContainer.addEventListener('drop', handleNameDrop);         // ê¸°ì¡´ í•¨ìˆ˜ ì´ë¦„ ë³€ê²½
            nameListContainer.addEventListener('dragend', handleNameDragEnd);   // ê¸°ì¡´ í•¨ìˆ˜ ì´ë¦„ ë³€ê²½

            // Global: Paste event handling to enforce Arial font on pasted content
            templateEditor.addEventListener('paste', () => {
                setTimeout(() => {
                    const elements = templateEditor.querySelectorAll('*');
                    elements.forEach(el => {
                        if (!el.style.fontFamily) {
                            el.style.fontFamily = FONT_FAMILY;
                        }
                    });
                }, 0);
            });

            // Editor Command Helper
            function executeCommand(command, value = null) {
                templateEditor.focus();
                try {
                    document.execCommand(command, false, value);
                } catch (error) {
                    console.error('Editing command failed:', command, error);
                }
            }
        }
        
        function initApp() {
            initListeners();
            // í´ë¼ìš°ë“œ ë™ê¸°í™” ëª¨ë“œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. (ì„¤ì • ëˆ„ë½ ì‹œ ë¡œì»¬ ì €ì¥ì†Œë¡œ ìë™ ì „í™˜ë¨)
            initFirebase(); 
            // initFirebase ë‚´ì—ì„œ startDataListenersê°€ í˜¸ì¶œë©ë‹ˆë‹¤.
        }

        initApp(); // ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
    </script>
</body>
</html>
